{% extends 'base.html' %}
{% load static humanize i18n %}

{% block title %}{{ product.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="product-page" style="max-width: 1100px; margin: 0 auto; padding: 24px 16px;">

  <!-- CARD SẢN PHẨM -->
  <div class="product-header-card"
       style="background: #fff; border-radius: 10px; padding: 24px;
              box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08); margin-bottom: 24px;
              display: flex; flex-wrap: wrap; gap: 30px;">

    {#  CỘT 1: ẢNH SẢN PHẨM   #}
    <div class="product-gallery-section" style="flex: 1; min-width: 300px;">
        <div class="main-image-wrapper" 
             style="border: 1px solid #eee; border-radius: 8px; overflow: hidden; 
                    background: #f9f9f9; display: flex; align-items: center; justify-content: center; height: 400px;">
            {% if product.images.first %}
                {# Hiển thị ảnh đầu tiên #}
                <img src="{{ product.images.first.image_url }}" 
                     alt="{{ product.name }}" 
                     style="max-width: 100%; max-height: 100%; object-fit: contain;">
            {% else %}
                <span style="color: #999;">{% trans "No Image" %}</span>
            {% endif %}
        </div>

        {# (Tùy chọn) Danh sách ảnh nhỏ bên dưới nếu có nhiều ảnh #}
        {% if product.images.count > 1 %}
        <div class="thumbnail-list" style="display: flex; gap: 10px; margin-top: 10px; overflow-x: auto;">
            {% for img in product.images.all %}
                <div style="width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; cursor: pointer;">
                    <img src="{{ img.image_url }}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {#  CỘT 2: THÔNG TIN SẢN PHẨM  #}
    <div class="product-main-info" style="flex: 1.5; min-width: 300px; display: flex; flex-direction: column;">
      <h1 class="product-title" style="font-size: 28px; font-weight: 700; margin-bottom: 10px; line-height: 1.3;">
        {{ product.name }}
      </h1>

      <div class="rating-summary-small" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
         <div class="rating-stars" style="color: #f59e0b;">
             <span style="font-weight: bold;">{{ average_rating|floatformat:1|intcomma }}</span> ★
         </div>
         <span style="color: #6b7280; font-size: 14px;">({{ rating_count }} {% trans "đánh giá" %})</span>
      </div>

      <p class="product-price" style="font-size: 26px; font-weight: 700; color: #dc2626; margin-bottom: 20px;">
        {{ product.price|floatformat:0|intcomma }} <span class="currency">{% trans "VNĐ" %}</span>
      </p>

      <div class="product-meta" style="font-size: 14px; color: #4b5563; margin-bottom: 20px;">
        <p style="margin-bottom: 5px;">{% trans "Danh mục" %}: <strong>{{ product.category.name|default:"Chưa phân loại" }}</strong></p>
        <p style="margin-bottom: 5px;">{% trans "Tình trạng" %}: 
            {% if product.stock_quantity > 0 %}
                <span style="color: #16a34a; font-weight: 600;">{% trans "Còn hàng" %} ({{ product.stock_quantity }})</span>
            {% else %}
                <span style="color: #dc2626; font-weight: 600;">{% trans "Hết hàng" %}</span>
            {% endif %}
        </p>
        {% if product.is_featured %}
          <span style="background: #f97316; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px;">{% trans "Nổi bật" %}</span>
        {% endif %}
      </div>

      <p class="product-description" style="color: #4b5563; margin-bottom: 30px; line-height: 1.6; border-top: 1px solid #eee; padding-top: 20px;">
        {{ product.description|default:_("Chưa có mô tả chi tiết.")|linebreaks }}
      </p>

      <div class="product-actions" style="margin-top: auto;">
        {% if product.stock_quantity > 0 %}
            {% if product.stock_quantity > 0 %}
            <div style="display: flex; gap: 10px;">
                <input type="number" 
                       id="quantity-input" 
                       value="1" 
                       min="1" 
                       max="{{ product.stock_quantity }}" 
                       style="width: 70px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; text-align: center;">
                
                <button type="button" 
                        onclick="addToCartDetail({{ product.id }})" 
                        class="btn btn-primary" 
                        style="background: #ff5722; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-weight: 600; cursor: pointer; flex-grow: 1;">
                    {% trans "Thêm vào giỏ hàng" %}
                </button>
            </div>
        {% else %}
            <button disabled style="width: 100%; background: #e5e7eb; color: #9ca3af; border: none; padding: 12px; border-radius: 6px; cursor: not-allowed; font-weight: 600;">
              {% trans "Sản phẩm tạm hết hàng" %}
            </button>
        {% endif %}
        {% else %}
            <button disabled style="width: 100%; background: #e5e7eb; color: #9ca3af; border: none; padding: 12px; border-radius: 6px; cursor: not-allowed; font-weight: 600;">
              {% trans "Sản phẩm tạm hết hàng" %}
            </button>
        {% endif %}
      </div>

    </div>
  </div>

    <!-- TÓM TẮT ĐÁNH GIÁ -->
    <div class="rating-summary"
         style="display: flex; align-items: center; gap: 10px; font-size: 14px;">

      {% if rating_count %}
        <div class="rating-score-wrapper" style="display: flex; align-items: baseline; gap: 4px;">
          <span class="rating-score-number" style="font-size: 26px; font-weight: 700;">
            {{ average_rating|floatformat:1|intcomma }}
          </span>
          <span class="rating-score-max" style="color: #6b7280;">/ 5</span>
        </div>

        <div class="rating-stars" style="font-size: 18px;">
          {% for i in "12345" %}
            {% if forloop.counter <= average_rating %}
              <span class="star filled" style="color: #f59e0b;">★</span>
            {% else %}
              <span class="star" style="color: #e5e7eb;">★</span>
            {% endif %}
          {% endfor %}
        </div>

        <div class="rating-count" style="color: #4b5563;">
          {{ rating_count }} {% trans "đánh giá" %}
        </div>
      {% else %}
        <div class="rating-none" style="color: #6b7280;">
          {% trans "Chưa có đánh giá nào cho sản phẩm này." %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- PHẦN ĐÁNH GIÁ / BÌNH LUẬN -->
  <div id="reviews" class="reviews-section"
       style="background: #fff; border-radius: 10px; padding: 20px 24px;
              box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);">

    <h2 class="section-title" style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
      {% trans "Đánh giá & Bình luận" %}
    </h2>

    {# --- Danh sách bình luận --- #}
    {% if comments %}
      <ul class="review-list" style="list-style: none; padding: 0; margin: 0 0 16px 0;">
        {% for c in comments %}
        <li class="review-item"
            style="border-bottom: 1px solid #e5e7eb; padding: 12px 0;">
          <div class="review-header" style="display: flex; justify-content: space-between; gap: 10px;">
            <div class="review-user" style="display: flex; gap: 10px; align-items: center;">
              <div class="avatar-circle"
                   style="width: 32px; height: 32px; border-radius: 999px;
                          background: #e5e7eb; display: flex; align-items: center;
                          justify-content: center; font-size: 14px; font-weight: 600;">
                {{ c.user.username|first|upper }}
              </div>
              <div>
                <div class="review-username" style="font-weight: 600;">
                  {{ c.user.username }}
                </div>
                <div class="review-date" style="font-size: 12px; color: #6b7280;">
                  {{ c.created_at|date:"d/m/Y H:i" }}
                </div>
              </div>
            </div>

            <div class="review-rating" style="text-align: right;">
              <div>
                {% for i in "12345" %}
                  {% if forloop.counter <= c.rating %}
                    <span class="star filled" style="color: #f59e0b;">★</span>
                  {% else %}
                    <span class="star" style="color: #e5e7eb;">★</span>
                  {% endif %}
                {% endfor %}
              </div>
              <span class="review-rating-number" style="font-size: 12px; color: #4b5563;">
                {{ c.rating }}/5
              </span>
            </div>
          </div>

          <div class="review-content" style="margin-top: 6px; color: #374151;">
            {{ c.content }}
          </div>

          {% if user.is_authenticated and user.id == c.user.id %}
            <form action="{% url 'comments:delete' c.id %}" method="post"
                  class="review-actions" style="margin-top: 6px;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm"
                      style="font-size: 12px; padding: 2px 8px;">
                Xóa
              </button>
            </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-review-text" style="color: #6b7280; margin-bottom: 16px;">
        {% trans "Chưa có bình luận nào, hãy là người đầu tiên đánh giá sản phẩm này!" %}
      </p>
    {% endif %}

    <hr class="section-divider" style="margin: 16px 0; border-color: #e5e7eb;">

    {# -- Không còn form đánh giá trực tiếp ở trang product -- #}
    {% if not user.is_authenticated %}
      {% url 'admin:login' as admin_login_url %}
      <p class="login-hint" style="color: #6b7280;">
        {% blocktrans with login_url=admin_login_url %}
        Bạn cần <a href="{{ login_url }}">đăng nhập</a> để xem lịch sử đơn hàng và đánh giá sản phẩm.
        {% endblocktrans %}
      </p>
    {% else %}
      <p class="no-permission-text" style="color: #6b7280;">
        {% trans "Để đánh giá sản phẩm, hãy vào" %}
        <strong>{% trans "Đơn hàng → Chi tiết đơn hàng" %}</strong> {% trans "tương ứng." %}
        {% trans "Bạn có thể đánh giá từng sản phẩm trong vòng" %}
        <strong>7 {% trans "ngày" %}</strong> {% trans "sau khi đơn được giao thành công." %}
      </p>
    {% endif %}
  </div>

</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
    const TOAST_ICONS = {
        success: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
    };

    function showToastClient(message, type = 'success') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.style.cssText = "position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;";
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast-message toast-${type}`;
        
        toast.style.cssText = `
            display: flex; align-items: center; background: #fff; border-radius: 8px; 
            padding: 12px 16px; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            border-left: 5px solid ${type === 'success' ? '#28a745' : '#dc3545'}; 
            animation: slideIn 0.3s ease-out forwards; margin-bottom: 10px;
        `;

        const iconColor = type === 'success' ? '#28a745' : '#dc3545';
        
        toast.innerHTML = `
            <div class="toast-icon" style="margin-right: 12px; color: ${iconColor}">
                ${TOAST_ICONS[type] || TOAST_ICONS.success}
            </div>
            <div class="toast-content" style="flex-grow: 1; font-size: 14px; color: #333;">${message}</div>
            <button onclick="this.parentElement.remove()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        `;

        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    function addToCartDetail(productId) {
        const qtyInput = document.getElementById('quantity-input');
        const quantity = parseInt(qtyInput.value);

        if (isNaN(quantity) || quantity < 1) {
          showToastClient('{% trans "Số lượng không hợp lệ" %}', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('quantity', quantity);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')

        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest' 
            },
            body: formData
        })
        .then(res => {
          if (!res.ok && res.status !== 400) throw new Error('{% trans "Lỗi mạng" %}');
            return res.json();
        })
        .then(data => {
            if (data.success) {
            showToastClient(data.message || '{% trans "Đã thêm vào giỏ hàng!" %}', 'success');
            } else {
            showToastClient(data.message || '{% trans "Có lỗi xảy ra" %}', 'error');
            }
        })
        .catch((err) => {
            console.error(err);
          showToastClient('{% trans "Có lỗi xảy ra khi kết nối server" %}', 'error');
        });
    }
</script>
{% endblock %}