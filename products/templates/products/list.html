{% extends 'base.html' %}
{% load static humanize i18n %}

{% block title %}{% trans "Danh sách sản phẩm" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="page-title">{% trans "Danh sách sản phẩm" %}</h1>
  <form method="get" class="filter-form">
      
      <input type="hidden" name="q" value="{{ current_q }}">

      <select name="category" class="filter-category">
          <option value="">-- {% trans "Danh mục" %} --</option>
          {% for cat in categories %}
              <option value="{{ cat.name }}"
                      {% if cat.name == current_category %}selected{% endif %}>
                  {{ cat.name }}
              </option>
          {% endfor %}
      </select>
      
            <input type="number" name="min_price" 
              placeholder="{% trans 'Giá từ' %}" 
              value="{{ current_min_price }}" 
              class="filter-input">
             
        <input type="number" name="max_price" 
           placeholder="{% trans 'Đến' %}" 
           value="{{ current_max_price }}" 
           class="filter-input">

        <div class="filter-actions">
          <button type="submit" 
              class="btn-primary-custom">
            {% trans "Lọc" %}
          </button>
          
          <a href="{% url 'products:list' %}" 
           class="btn-outline-custom">
            {% trans "Reset" %}
          </a>
        </div>
  </form>

  {% if products %}
    <div class="product-grid">
      {% for product in products %}
        <div class="product-card">
          
          <div class="product-image" style="height: 180px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background: #f9f9f9; border-radius: 4px;">
              {% if product.images.first %}
                  {# Nếu có ảnh thì hiển thị ảnh đầu tiên #}
                  <a href="{% url 'products:detail' product.pk %}" style="display: block; width: 100%; height: 100%;">
                      <img src="{{ product.images.first.image_url }}" 
                           alt="{{ product.name }}" 
                           style="width: 100%; height: 100%; object-fit: contain;">
                  </a>
              {% else %}
                  {# Nếu không có ảnh thì hiện chữ No Image #}
                  <span style="color: #ccc; font-size: 14px;">No Image</span>
              {% endif %}
          </div>

          <div class="product-name">
            <a href="{% url 'products:detail' product.pk %}">
              {{ product.name }}
            </a>
          </div>

          <div class="product-price">
            {{ product.price|floatformat:0|intcomma }} {% trans "VNĐ" %}
          </div>

          {% if product.category %}
            <div class="product-category">
              {% trans "Danh mục" %}: {{ product.category.name }}
            </div>
          {% endif %}

          <div class="product-stock">
            {% trans "Còn lại" %}: {{ product.stock_quantity }}
          </div>

          <div class="product-actions">
            <a href="{% url 'products:detail' product.pk %}" class="btn-outline-custom">
              {% trans "Xem chi tiết" %}
            </a>
            
            <form action="{% url 'cart:add' product.id %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              {% if product.stock_quantity > 0 %}
               <button type="button" 
                onclick="addToCart({{ product.id }})" 
                class="btn-primary-custom">
              {% trans "Thêm vào giỏ" %}
        </button>
              {% else %}
                <button disabled 
                        style="background: #ccc; color: #fff; border: none; cursor: not-allowed; padding: 6px 12px; border-radius: 4px;">
                    {% trans "Hết hàng" %}
                </button>
              {% endif %}
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>{% trans "Hiện chưa có sản phẩm nào." %}</p>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
    {# Giữ lại scripts của base.html nếu có #}
    <script src="{% static 'js/main.js' %}"></script> 

    <script>
        // ==========================================
        // 1. HÀM HIỆN TOAST (Client-side)
        // ==========================================
        function showToastClient(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            
            let iconHtml = '';
            if (type === 'success') {
                iconHtml = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toast-icon-success"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
            } else if (type === 'error') {
                iconHtml = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toast-icon-error"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            }

            toast.innerHTML = `
                <div class="toast-icon">${iconHtml}</div>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = "fadeOut 0.5s ease-out forwards";
                toast.addEventListener("animationend", () => {
                    if(toast.parentElement) toast.remove();
                });
            }, 4000);
        }

        // ==========================================
        // 2. HÀM GỌI AJAX THÊM GIỎ HÀNG
        // ==========================================
        function addToCart(productId) {
            const url = '/cart/add/' + productId + '/'; 
            const csrfToken = '{{ csrf_token }}'; // Lấy token từ Django template

            fetch(url, {
                method: 'POST', 
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ quantity: 1 }) // Mặc định thêm 1
            })
            .then(response => {
              // Dù server trả về redirect (302) hay JSON (200), ta đều coi là thành công
              // vì fetch tự động follow redirect nhưng không đổi URL trên thanh địa chỉ.
              if (response.ok || response.redirected) {
                 showToastClient('{% trans "Đã thêm sản phẩm vào giỏ hàng!" %}', 'success');
              } else {
                 showToastClient('{% trans "Có lỗi xảy ra, vui lòng thử lại." %}', 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              // Trường hợp view redirect thành công nhưng fetch coi là lỗi mạng (hiếm gặp)
              showToastClient('{% trans "Đã thêm sản phẩm vào giỏ hàng!" %}', 'success');
            });
        }
    </script>
{% endblock %}