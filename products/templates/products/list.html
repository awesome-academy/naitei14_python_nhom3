{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Danh sách sản phẩm{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="page-title">Danh sách sản phẩm</h1>
  <form method="get" class="filter-form" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
      
      <input type="hidden" name="q" value="{{ current_q }}">

      <select name="category"
        style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; max-width: 260px;">
          <option value="">-- Danh mục --</option>
          {% for cat in categories %}
              <option value="{{ cat.name }}"
                      {% if cat.name == current_category %}selected{% endif %}>
                  {{ cat.name }}
              </option>
          {% endfor %}
      </select>
      
      <input type="number" name="min_price" 
             placeholder="Giá từ" 
             value="{{ current_min_price }}" 
             style="padding: 6px 10px; border-radius: 4px; max-width: 120px; border: 1px solid #ddd;">
             
      <input type="number" name="max_price" 
             placeholder="Đến" 
             value="{{ current_max_price }}" 
             style="padding: 6px 10px; border-radius: 4px; max-width: 120px; border: 1px solid #ddd;">
             
      <button type="submit" 
              class="btn-primary-custom" 
              style="padding: 8px 16px;">
          Lọc
      </button>
      
      <a href="{% url 'products:list' %}" 
         class="btn-outline-custom" 
         style="padding: 7px 16px;">
          Reset
      </a>
  </form>

  {% if products %}
    <div class="product-grid">
      {% for product in products %}
        <div class="product-card">
          
          <div class="product-image" style="height: 180px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background: #f9f9f9; border-radius: 4px;">
              {% if product.images.first %}
                  {# Nếu có ảnh thì hiển thị ảnh đầu tiên #}
                  <a href="{% url 'products:detail' product.pk %}" style="display: block; width: 100%; height: 100%;">
                      <img src="{{ product.images.first.image_url }}" 
                           alt="{{ product.name }}" 
                           style="width: 100%; height: 100%; object-fit: contain;">
                  </a>
              {% else %}
                  {# Nếu không có ảnh thì hiện chữ No Image #}
                  <span style="color: #ccc; font-size: 14px;">No Image</span>
              {% endif %}
          </div>

          <div class="product-name">
            <a href="{% url 'products:detail' product.pk %}">
              {{ product.name }}
            </a>
          </div>

          <div class="product-price">
            {{ product.price|floatformat:0|intcomma }} VNĐ
          </div>

          {% if product.category %}
            <div class="product-category">
              Danh mục: {{ product.category.name }}
            </div>
          {% endif %}

          <div class="product-stock">
            Còn lại: {{ product.stock_quantity }}
          </div>

          <div class="product-actions">
            <a href="{% url 'products:detail' product.pk %}" class="btn-outline-custom">
              Xem chi tiết
            </a>
            
            <form action="{% url 'cart:add' product.id %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              {% if product.stock_quantity > 0 %}
                <button type="submit" class="btn-primary-custom">
                  Thêm vào giỏ
                </button>
              {% else %}
                <button disabled 
                        style="background: #ccc; color: #fff; border: none; cursor: not-allowed; padding: 6px 12px; border-radius: 4px;">
                    Hết hàng
                </button>
              {% endif %}
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Hiện chưa có sản phẩm nào.</p>
  {% endif %}
</div>
{% endblock %}
